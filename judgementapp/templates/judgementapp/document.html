{% extends "judgementapp/base.html" %}

{% block content %}
{% load custom_tags %}

<style>
    #summary h6.collapse:not(.show) {
        height: 0px !important;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;  
    }
    #summary h6.collapsing { min-height: 0px !important; }
    #summary a.collapsed:after  { content: '(show target)'; }
    #summary a:not(.collapsed):after { content: '(hide target)'; }
</style>

<div class="card">

<div class="card-body">
    <h5 class="card-title">Task 2 - Bubric-based Passage Judgement</h5>
    <p class="card-text">
        <h6 class="card-title">Detail guildlines</h6>
        For this task, annotators should access the relevance of reference (i.e., the document in IR). 
        Follow common IR setting, we adopt the graded labels from 0 to 2.<br/>
        <ul>
            <li>Not relevant: the passage is irrelevant to your judgment of highlights</li>
            <li>Somewhat relevant: the passage is relevant to your judgment of highlights.</li>
            <li>Highly relevant: the information in the passage can be crucial to your judgment of highlights.</li>
        </ul>
        Here are <a href="{{ request.path }}examples">some examples</a> for highlighting tasks.
    </p>
</div>

<div class="card text-left m-2">
    <div class="row card-body">
        <h6>ID: <i>{{query.qId}}</i></h6>
    </div>

    <div class="card-body row">
        <h6>Open-ended Query</h6>
        <p>{{ query.text }}</p>
    </div>

    <div class="card-body row">
        {% if query.unfinished %} 
            <h6>NO judged nuggets found</h6>
        {% else %}
            {% for i, question in query.questions.items %}
                {% if query.nuggets|get_item:i %}
                    <div class="col">
                        <h6>Question</h6>
                        <p>{{ question }}</p>
                    </div>
                    <div class="col">
                        <h6>Nugget <a href="{% url 'query' qId=query.qId %}" class="btn btn-link btm-sm">(edit nugget)</a></h6>
                        <p>{{ query.nuggets|get_item:'0' }}</p>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
</div>

<div class="card text-left m-2">
    <div class="card-body row">
        <h6>Passage ID: <i>{{ document.docId }}</i> ({{ rank }} / {{total_rank}}) </h6>
    </div>

    <div class="card-body row">
        <div class="col">
            <h6>{{ document.text }} </h6>
        </div>
        <div style="height:100; position:relative; overflow-y: scroll;" id='content'>
          <p>{{ content }}</p>
        </div>
    </div>

    <div class="card-body row">
        <div class="col">
            {% if prev %}
            <a href="{% url 'document' qId=query.qId docId=prev.document.docId %}" class="btn btn-outline-dark btn-sm">Prev Document</a>
            {% endif %}
        </div>
        <div class="col" align="right">
            {% if next %}
            <a href="{% url 'document' qId=query.qId docId=next.document.docId %}" class="btn btn-outline-dark btn-sm">Next Document</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="card text-left m-2">
    <form class="form-inline" action="{% url 'judge' qId=query.qId docId=document.docId %}" method="post">
    <div class="row card-body">
        <div class="col">
            <h6>Judge the anwerability of the context</h6>
            <p>Determine whether the question can be answered based on the provided context?
            Rate the context with on a scale from 0 to 5 according to the guideline below.</p>
            {% csrf_token %}

{# "- 5: The context is highly relevant, complete, and accurate.\n" + \ #}
{# "- 4: The context is mostly relevant and complete but may have minor gaps or inaccuracies.\n" + \ #}
{# "- 3: The context is partially relevant and complete, with noticeable gaps or inaccuracies.\n" + \ #}
{# "- 2: The context has limited relevance and completeness, with significant gaps or inaccuracies.\n" + \ #}
{# "- 1: The context is minimally relevant or complete, with substantial shortcomings.\n" + \ #}
{# "- 0: The context is not relevant or complete at all." #}
{#  #}
            {% if query.type.0 != 1%} {# if it is not a highlight --> not relevant referneces#}
            <div class="form-check" id="relevance-labels">
                <input type="radio" name="relevance" id="relevance-1" value="-1" {% if judgement.relevance == -1 %} checked {% endif %}>
                <label class="radio"> Unjudged </label></br>
                <input type="radio" name="relevance" id="relevance5" value="5" {% if judgement.relevance == 5 %} checked {% endif %}>
                <label class="radio"> (5) highly relevant, complete, and accurate.</label></br>
                <input type="radio" name="relevance" id="relevance5" value="4" {% if judgement.relevance == 4 %} checked {% endif %}>
                <label class="radio"> (4)  mostly relevant and complete but may have minor gaps or inaccuracies.</label></br>
                <input type="radio" name="relevance" id="relevance3" value="3" {% if judgement.relevance == 3 %} checked {% endif %}>
                <label class="radio"> (3) partially relevant and complete, with noticeable gaps or inaccuracies.</label></br>
                <input type="radio" name="relevance" id="relevance2" value="2" {% if judgement.relevance == 2 %} checked {% endif %}>
                <label class="radio"> (2) limited relevance and completeness, with significant gaps or inaccuracies.</label></br>
                <input type="radio" name="relevance" id="relevance1" value="1" {% if judgement.relevance == 1 %} checked {% endif %}>
                <label class="radio"> (1) minimally relevant or complete, with substantial shortcomings.</label></br>
                <input type="radio" name="relevance" id="relevance0" value="0" {% if judgement.relevance == 0 %} checked {% endif %}>
                <label class="radio"> (0) minimally relevant or complete, with substantial shortcomings.</label></br>
            </div>
            {% else %}
            <div class="form-check" id="relevance-labels">
                <input type="radio" name="relevance" id="relevance1" value="-1" {% if judgement.relevance == -1 %} checked {% endif %}>
                <label class="radio"> Unjudged </label></br>
            </div>
            {% endif %}
        </div>

        <div class="col">
            <div class="control-group">
                <script type="text/javascript">
                  function getSelectedText() {
                      if (window.getSelection) {
                          return window.getSelection().toString();
                      } else if (document.selection) {
                          return document.selection.createRange().text;
                      }
                      return '';
                  }

                  function captureSelection() {
                    textarea = document.getElementById('comment');
                    {# if (textarea.value=='Comments') { #}
                    if (textarea.value.length == 0) {
                      textarea.value = getSelectedText();
                    } else if (textarea.value.length > 0) {
                      textarea.value = textarea.value + ' ||| ' + getSelectedText();
                    }
                  }

                  // Keyboard shortcuts for faster judging.
                  document.addEventListener("DOMContentLoaded", function() {
                      let btn = {% if next %} document.getElementById("btn-next") {% else %} document.getElementById("btn-save") {% endif %}
                      let els = document.querySelectorAll("#relevance-labels > label > input");
                      document.onkeypress = function (e) {
                          e = e || window.event;
                          value = e.keyCode - 49
                          if (value >= 0 && value < els.length) {
                              els[value].checked = 1
                              btn.click();
                          }
                      };
                  });
                </script>

                <h6>The Rationale of nugget</h6>
                <p>Why you judge the passage can answer the question? Type or
                <button type="button" class="btn btn-warning btn-sm" id="capture" onclick="captureSelection()">highlight</button>
                 <div class="control-group">
                    <div class="controls">
                      <textarea style="width:100%" id="comment" name="comment">{% if judgement.comment %}{{ judgement.comment }}{% else %}{% endif %}</textarea>
                    </div>
                  </div>
            </div>
        </div>
    </div>

    <div class="card-body row">
        <div class="col">
            {% if next_query %}
                <a href="{% url 'query' qId=next_query.qId%}" class="btn btn-outline-dark btn-sm">Next Query</a>
            {% endif %}
        </div>
        <div class="col">
            <div class="form-actions" align="right">
                <button id="btn-save" type="submit" class="btn btn-outline-primary btn-sm">Save</button> 
                {% if next %}
                <button id="btn-next" type="submit" name="next" class="btn btn-outline-primary btn-sm">
                    Save and Next</button> 
                {% endif %}
            </div>
        </div>
    </div>
    </form>
</div>
</div>

{% endblock %}
